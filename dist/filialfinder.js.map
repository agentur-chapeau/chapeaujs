{"version":3,"file":"filialfinder.js","sources":["../src/scripts/filialfinder.js"],"sourcesContent":["import { exportChapeau } from \"../utils/export_chapeau\";\n\nlet getMapOptions = () => {\n  return {\n    zoom: 15,\n    center: new google.maps.LatLng(51.8822652, 8.5058202),\n    mapTypeId: google.maps.MapTypeId.ROADMAP,\n  };\n};\n\nlet getIcon = () => {\n  return {\n    url: \"https://cdn.prod.website-files.com/60d5998f051d878a160147f3/60d5a34ef2a5ad2788d45830_baeckereischumacher_300_180-300x180.png\",\n    anchor: new google.maps.Point(40, 45.25),\n    scaledSize: new google.maps.Size(80, 90.5),\n  };\n};\n\nlet gmarkers = {};\nlet map;\nlet locationMarker;\n\nif (sessionStorage.getItem(\"c-accept_gm\") === \"true\") {\n  loadFilialfinder();\n}\n\nfunction loadFilialfinder() {\n  const scriptTag = document.createElement(\"script\");\n  scriptTag.setAttribute(\n    \"src\",\n    \"https://maps.googleapis.com/maps/api/js?key=&amp\",\n  );\n  scriptTag.setAttribute(\"async\", true);\n  scriptTag.addEventListener(\"load\", initializeMap);\n\n  document.body.appendChild(scriptTag);\n  sessionStorage.setItem(\"c-accept_gm\", true);\n}\n\nfunction initializeMap() {\n  function createMarker(latlng, html) {\n    const marker = new google.maps.Marker({\n      position: latlng,\n      icon: getIcon(),\n      map: map,\n    });\n\n    marker.addListener(\"click\", () => {\n      infoWindow.setContent(html);\n      infoWindow.open(map, marker);\n    });\n\n    return marker;\n  }\n\n  map = new google.maps.Map(\n    document.querySelector('[ff-element=\"map\"]'),\n    getMapOptions(),\n  );\n\n  const infoWindow = new google.maps.InfoWindow();\n\n  Array.from(\n    document.querySelectorAll('[ff-element=\"list\"] > [ff-element=\"item\"]'),\n  ).forEach((item) => {\n    const slug = item.querySelector('[ff-element=\"slug\"]').innerText;\n    const lat = item.querySelector('[ff-element=\"lat\"]').innerText;\n    const long = item.querySelector('[ff-element=\"long\"]').innerText;\n    const infoHTML = item.querySelector('[ff-element=\"info\"]').outerHTML;\n\n    gmarkers[slug] = createMarker(new google.maps.LatLng(lat, long), infoHTML);\n  });\n\n  Array.from(document.querySelectorAll('[ff-element=\"request\"]')).forEach(\n    (requestBtn) => {\n      requestBtn.addEventListener(\"click\", requestLocation);\n    },\n  );\n\n  Array.from(document.querySelectorAll('[ff-element=\"show\"]')).forEach(\n    (showBtn) => {\n      showBtn.addEventListener(\"click\", showItem);\n    },\n  );\n}\n\nfunction showItem(event) {\n  const btn = event.currentTarget;\n  const item = btn.closest('[ff-element=\"item\"]');\n  if (item) {\n    const slug = item.querySelector('[ff-element=\"slug\"]').innerText;\n    google.maps.event.trigger(gmarkers[slug], \"click\");\n    document\n      .querySelector('[ff-element=\"map\"]')\n      .scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n  }\n}\n\nfunction requestLocation() {\n  if (navigator.geolocation) {\n    navigator.geolocation.getCurrentPosition(handlePosition, handleError);\n    document.querySelector('[ff-element=\"loading\"]').style.display = \"block\";\n  } else {\n    alert(\"Die Standortermittlung wird von diesem Browser nicht unterstützt.\");\n  }\n}\n\nfunction handlePosition(position) {\n  const lat = position.coords.latitude;\n  const long = position.coords.longitude;\n  displayPosition(lat, long);\n  sortByPosition(lat, long);\n\n  document.querySelector('[ff-element=\"loading\"]').style.display = \"none\";\n}\n\nfunction handleError(error) {\n  switch (error.code) {\n    case error.PERMISSION_DENIED:\n      alert(\"Die Berechtigung zur Standortermittlung wurde nicht erteilt.\");\n      break;\n    case error.POSITION_UNAVAILABLE:\n      alert(\"Standort ist momentan nicht verfügbar.\");\n      break;\n    case error.TIMEOUT:\n      alert(\"Zeitüberschreitung bei Standortermittlung.\");\n      break;\n    case error.UNKNOWN_ERROR:\n      alert(\"Ein unbekannter Fehler ist aufgetreten.\");\n      break;\n  }\n\n  document.querySelector('[ff-element=\"loading\"]').style.display = \"none\";\n}\n\nfunction displayPosition(lat, long) {\n  const latlong = new google.maps.LatLng(lat, long);\n  map.panTo(latlong);\n  map.setZoom(15);\n\n  if (locationMarker) {\n    locationMarker.setMap(null);\n  }\n\n  locationMarker = new google.maps.Marker({\n    position: latlong,\n    map: map,\n  });\n\n  const infoWindow = new google.maps.InfoWindow({\n    content: \"Dein aktueller Standort\",\n  });\n\n  locationMarker.addListener(\"click\", () => {\n    infoWindow.open(map, locationMarker);\n  });\n}\n\nfunction sortByPosition(userLat, userLong) {\n  function compare(left, right) {\n    const leftLat = left.querySelector('[ff-element=\"lat\"]').innerText;\n    const leftLong = left.querySelector('[ff-element=\"long\"]').innerText;\n\n    const rightLat = right.querySelector('[ff-element=\"lat\"]').innerText;\n    const rightLong = right.querySelector('[ff-element=\"long\"]').innerText;\n\n    const leftDistance = computeDistance(userLat, userLong, leftLat, leftLong);\n    const rightDistance = computeDistance(\n      userLat,\n      userLong,\n      rightLat,\n      rightLong,\n    );\n\n    return leftDistance < rightDistance ? -1 : 1;\n  }\n\n  let list = document.querySelectorAll(\n    '[ff-element=\"list\"] > [ff-element=\"item\"]',\n  );\n  list = Array.from(list);\n  list.sort(compare);\n  for (const item of list) {\n    item.parentElement.appendChild(item);\n  }\n}\n\nfunction computeDistance(lat1, long1, lat2, long2) {\n  // Source: https://www.movable-type.co.uk/scripts/latlong.html\n  const R = 6371e3; // metres\n  const φ1 = (lat1 * Math.PI) / 180; // φ, λ in radians\n  const φ2 = (lat2 * Math.PI) / 180;\n  const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n  const Δλ = ((long2 - long1) * Math.PI) / 180;\n\n  const a =\n    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  const d = R * c; // in metres\n\n  return d;\n}\n\nfunction setMapOptions(getMapOptionsCallback) {\n  getMapOptions = getMapOptionsCallback;\n}\n\nfunction setIcon(getIconCallback) {\n  getIcon = getIconCallback;\n}\n\nexportChapeau({\n  loadFilialfinder,\n  setMapOptions,\n  setIcon,\n});\n"],"names":[],"mappings":"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"}